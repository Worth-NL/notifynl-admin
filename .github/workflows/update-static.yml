name: Update static media

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to upload static media"
        required: true
        type: choice
        options:
          - test
          - prod
        default: test
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
        node-version: ["22"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}
          activate-environment: true
          enable-cache: true
          cache-dependency-glob: |
            requirements_for_test.in
            requirements_for_test.txt
            requirements_nl_test.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Bootstrap
        run: make bootstrap-nl
        shell: bash

      - name: Verify static output
        run: |
          test -d ./app/static && test "$(ls -A ./app/static)" || {
            echo "‚ùå Static build failed or output is empty"
            exit 1
          }

      - name: Upload static files
        run: make upload-static-nl-${{ inputs.environment }}

      - name: Invalidate CloudFront cache
        if: ${{ inputs.environment == 'prod' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DIST_ID }} \
            --paths "/*"

      - name: Invalidate CloudFront cache (test)
        if: ${{ inputs.environment == 'test' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DIST_ID_TEST }} \
            --paths "/*"
